#!/bin/bash

# ==================================================
# VPS 流量控制台 V5.0 (UI修复版)
# 特性：完美对齐 | 无乱码 | 活跃连接深度分析 | 全局/端口限速
# ==================================================

# --- 1. 颜色定义 (修复乱码核心：使用 ANSI C Quoting) ---
# 这样定义后，printf 能够正确识别它们为控制符，而不是文字
RED=$'\e[31m'
GREEN=$'\e[32m'
YELLOW=$'\e[33m'
BLUE=$'\e[36m'
PLAIN=$'\e[0m'
BOLD=$'\e[1m'

# 检查 root 权限
[[ $EUID -ne 0 ]] && echo -e "${RED}错误：${PLAIN} 必须使用 root 用户运行此脚本！\n" && exit 1

# 自动获取物理网卡名称
INTERFACE=$(ip route get 8.8.8.8 | awk '{print $5; exit}')

# ================= 核心工具函数 =================

function init_tc_tree() {
    if ! tc qdisc show dev $INTERFACE | grep -q "htb"; then
        tc qdisc add dev $INTERFACE root handle 1: htb default 10
    fi
    if ! tc class show dev $INTERFACE | grep -q "1:1 "; then
        tc class add dev $INTERFACE parent 1: classid 1:1 htb rate 10000mbit
    fi
    if ! tc class show dev $INTERFACE | grep -q "1:10 "; then
        tc class add dev $INTERFACE parent 1:1 classid 1:10 htb rate 10000mbit
    fi
    if ! tc qdisc show dev $INTERFACE | grep -q "ingress"; then
        tc qdisc add dev $INTERFACE handle ffff: ingress
    fi
}

# --- 功能 1：活跃端口扫描 (修复显示与对齐) ---
function check_port_status() {
    clear
    echo -e "${YELLOW}[Scanning] 深度端口连接分析...${PLAIN}"
    echo -e "----------------------------------------------------------------------------------"
    # 使用 printf 进行严格的列对齐 (颜色代码放在 %s 之外，不影响宽度计算)
    printf "${BOLD}%-10s %-12s %-15s %-15s %-20s${PLAIN}\n" "协议" "端口" "监听状态" "活跃连接数" "进程/服务"
    echo -e "----------------------------------------------------------------------------------"

    # 获取所有监听端口
    # 格式化输出: Proto, Local-Address, Process
    ss -tulpn | grep LISTEN | awk '{print $1, $5, $7}' | while read -r proto address process; do
        
        # 提取端口号
        port=$(echo "$address" | awk -F':' '{print $NF}')
        
        # 1. 处理协议显示颜色
        if [[ "$proto" == "tcp" ]]; then
            proto_display="${GREEN}TCP${PLAIN}"
        else
            proto_display="${BLUE}UDP${PLAIN}"
        fi

        # 2. 统计活跃连接 (ESTABLISHED)
        # 只有真正建立的数据传输连接才算活跃，排除监听本身
        if [[ "$proto" == "tcp" ]]; then
            # 精确匹配 :端口号 的已建立连接
            conn_count=$(ss -tn state established | awk '{print $4}' | grep -w ":$port" | wc -l)
        else
            conn_count=$(ss -un | awk '{print $4}' | grep -w ":$port" | wc -l)
        fi

        # 3. 处理活跃度显示颜色
        if [[ "$conn_count" -gt 0 ]]; then
            conn_display="${RED}${conn_count} (Active)${PLAIN}"
        else
            conn_display="${PLAIN}0 (Idle)"
        fi

        # 4. 提取进程名
        proc_name=$(echo "$process" | awk -F'"' '{print $2}')
        [[ -z "$proc_name" ]] && proc_name="未知"

        # 5. 打印一行 (注意：颜色代码放在参数里，调整 printf 宽度以适应颜色代码长度，或者分段打印)
        # 为了完美对齐，我们将颜色剥离出 printf 的宽度计算逻辑
        # 这里使用一种 trick：printf 打印纯文本占位，颜色手动插入
        
        printf "%-18b %-12s %-15s %-25b %-20s\n" "${proto_display}" "${port}" "Listening" "${conn_display}" "${proc_name}"
    done
    echo -e "----------------------------------------------------------------------------------"
    echo -e "${PLAIN}说明：'活跃连接数' 指当前正在传输数据的连接 (Established)。${PLAIN}"
}

# --- 功能 2：端口限速 ---
function apply_port_limit() {
    local direction=$1
    echo -e "\n${BLUE}--- 配置端口限速 ($direction) ---${PLAIN}"
    read -p "请输入端口号: " PORT
    read -p "请输入速率 (Mbps): " RATE_MBPS
    
    RATE_KBIT=$(($RATE_MBPS * 1000))
    BURST="100k"
    init_tc_tree

    if [[ "$direction" == "out" || "$direction" == "bi" ]]; then
        tc filter del dev $INTERFACE parent 1:0 prio $PORT >/dev/null 2>&1
        tc class del dev $INTERFACE parent 1:1 classid 1:$PORT >/dev/null 2>&1
        tc class add dev $INTERFACE parent 1:1 classid 1:$PORT htb rate ${RATE_KBIT}kbit ceil ${RATE_KBIT}kbit burst $BURST
        tc filter add dev $INTERFACE protocol ip parent 1:0 prio $PORT u32 match ip sport $PORT 0xffff flowid 1:$PORT
    fi

    if [[ "$direction" == "in" || "$direction" == "bi" ]]; then
        tc filter del dev $INTERFACE parent ffff: prio $PORT >/dev/null 2>&1
        tc filter add dev $INTERFACE parent ffff: protocol ip prio $PORT u32 match ip dport $PORT 0xffff \
        police rate ${RATE_KBIT}kbit burst $BURST drop flowid :1
    fi
    echo -e "${GREEN}[Success] 端口 $PORT 限速已生效！${PLAIN}"
}

# --- 功能 3：全局限速 ---
function apply_global_limit() {
    echo -e "\n${BLUE}--- 全局限速 (整机) ---${PLAIN}"
    read -p "请输入总速率限制 (Mbps): " RATE_MBPS
    RATE_KBIT=$(($RATE_MBPS * 1000))
    BURST="100k"
    
    tc qdisc del dev $INTERFACE root >/dev/null 2>&1
    tc qdisc del dev $INTERFACE ingress >/dev/null 2>&1

    tc qdisc add dev $INTERFACE root handle 1: htb default 10
    tc class add dev $INTERFACE parent 1: classid 1:1 htb rate ${RATE_KBIT}kbit ceil ${RATE_KBIT}kbit burst $BURST
    tc class add dev $INTERFACE parent 1:1 classid 1:10 htb rate ${RATE_KBIT}kbit ceil ${RATE_KBIT}kbit burst $BURST

    tc qdisc add dev $INTERFACE handle ffff: ingress
    tc filter add dev $INTERFACE parent ffff: protocol ip prio 50 u32 match ip src 0.0.0.0/0 \
    police rate ${RATE_KBIT}kbit burst $BURST drop flowid :1

    echo -e "${GREEN}[Success] 全局限速已生效！${PLAIN}"
}

# --- 功能 4：解除限制 ---
function remove_limit() {
    echo -e "\n1. 解除指定端口"
    echo -e "2. 重置所有限制"
    read -p "选择: " sel
    if [[ "$sel" == "1" ]]; then
        read -p "端口号: " PORT
        tc filter del dev $INTERFACE parent 1:0 prio $PORT >/dev/null 2>&1
        tc class del dev $INTERFACE parent 1:1 classid 1:$PORT >/dev/null 2>&1
        tc filter del dev $INTERFACE parent ffff: prio $PORT >/dev/null 2>&1
        echo -e "${GREEN}端口 $PORT 已解除。${PLAIN}"
    elif [[ "$sel" == "2" ]]; then
        tc qdisc del dev $INTERFACE root >/dev/null 2>&1
        tc qdisc del dev $INTERFACE ingress >/dev/null 2>&1
        echo -e "${GREEN}网卡已重置。${PLAIN}"
    fi
}

# --- 功能 5：测速 ---
function run_pro_speedtest() {
    echo -e "${YELLOW}[Check] 正在调用 Speedtest...${PLAIN}"
    if [ ! -f "./speedtest" ]; then
        ARCH=$(uname -m)
        [[ "$ARCH" == "x86_64" ]] && URL="https://install.speedtest.net/app/cli/ookla-speedtest-1.2.0-linux-x86_64.tgz"
        [[ "$ARCH" == "aarch64" ]] && URL="https://install.speedtest.net/app/cli/ookla-speedtest-1.2.0-linux-aarch64.tgz"
        curl -sL $URL | tar xz speedtest && chmod +x speedtest
    fi
    ./speedtest --accept-license --accept-gdpr
}

# ================= 主菜单 =================
function show_menu() {
    clear
    echo -e "=================================================="
    echo -e "       VPS 流量控制台 V5.0 (UI修复版)"
    echo -e "       网卡: ${GREEN}${INTERFACE}${PLAIN}"
    echo -e "=================================================="
    echo -e "1. 查看活跃端口 (无乱码/详细)"
    echo -e "--------------------------------------------------"
    echo -e "2. 设置 ${YELLOW}指定端口${PLAIN} 限速"
    echo -e "3. 设置 ${RED}全局网卡${PLAIN} 限速"
    echo -e "--------------------------------------------------"
    echo -e "4. 解除限制"
    echo -e "5. 运行测速"
    echo -e "0. 退出"
    echo -e "=================================================="
    read -p "选择: " choice

    case $choice in
        1) check_port_status; read -p "回车返回..." ;;
        2) apply_port_limit "bi"; read -p "回车返回..." ;;
        3) apply_global_limit; read -p "回车返回..." ;;
        4) remove_limit; read -p "回车返回..." ;;
        5) run_pro_speedtest; read -p "回车返回..." ;;
        0) exit 0 ;;
        *) show_menu ;;
    esac
    show_menu
}

show_menu
