#!/bin/bash

# ==================================================
# 端口限速 & 状态监控脚本 (V2.0 增强版)
# 功能：双向限速、端口连接可视化、可靠测速、交互菜单
# ==================================================

# 颜色定义
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[36m'
PLAIN='\033[0m'

# 1. 自动获取网卡名称
INTERFACE=$(ip route get 8.8.8.8 | awk '{print $5; exit}')

# 检查是否以root运行
[[ $EUID -ne 0 ]] && echo -e "${RED}错误：${PLAIN} 必须使用 root 用户运行此脚本！\n" && exit 1

# ================= 核心功能函数 =================

# --- 功能 1：端口连接扫描 (优化中文显示 & 统计) ---
function check_port_status() {
    echo -e "${YELLOW}[INFO] 正在扫描活跃端口连接...${PLAIN}"
    echo -e "------------------------------------------------------"
    printf "%-10s %-15s %-10s %-20s\n" "协议" "本地端口" "连接数" "状态说明"
    echo -e "------------------------------------------------------"

    # 使用 ss 命令获取数据
    # 过滤 TCP 和 UDP 监听及建立的连接
    
    # 获取所有监听端口
    listeners=$(ss -tunlp | grep LISTEN | awk '{print $1, $5}' | sed 's/.*://g')
    
    while read -r proto port; do
        # 转换显示名称
        if [[ "$proto" == "tcp" ]]; then
            proto_cn="TCP连接"
        elif [[ "$proto" == "udp" ]]; then
            proto_cn="UDP连接"
        else
            proto_cn="未知"
        fi

        # 统计该端口的活跃连接数 (ESTABLISHED)
        conn_count=$(ss -tun | grep ":$port " | grep "ESTAB" | wc -l)
        
        printf "%-10s %-15s %-10s %-20s\n" "${proto_cn}" "${port}" "${conn_count}" "正在监听"
    done <<< "$listeners"
    echo -e "------------------------------------------------------"
}

# --- 功能 2：限速规则设置 (包含双向限速) ---
function set_limit() {
    read -p "请输入要限制的端口号 (例如 8080): " PORT
    read -p "请输入限速带宽 (单位 Mbps, 例如 20): " RATE
    
    # 转换为 kbit (tc使用单位)
    RATE_KBIT=$(($RATE * 1000))
    BURST="100k" # 突发缓冲

    echo -e "${YELLOW}[Processing] 正在对端口 $PORT 实施 $RATE Mbps 的双向限速...${PLAIN}"

    # 清理旧规则 (防止冲突)
    clear_rules_silent

    # 1. 下行限速 (Egress - 服务器发出的数据)
    # 建立根队列
    tc qdisc add dev $INTERFACE root handle 1: htb default 10
    # 建立主类，总带宽设大一点以免影响其他端口 (例如 10Gbps)
    tc class add dev $INTERFACE parent 1: classid 1:1 htb rate 10000mbit
    # 建立限速子类
    tc class add dev $INTERFACE parent 1:1 classid 1:10 htb rate ${RATE_KBIT}kbit ceil ${RATE_KBIT}kbit burst $BURST
    # 设置过滤器：匹配源端口是 $PORT 的包 (发给用户的)
    tc filter add dev $INTERFACE protocol ip parent 1:0 prio 1 u32 match ip sport $PORT 0xffff flowid 1:10

    # 2. 上行限速 (Ingress - 服务器接收的数据)
    # 添加 ingress qdisc
    tc qdisc add dev $INTERFACE handle ffff: ingress
    # 设置过滤器：匹配目的端口是 $PORT 的包 (用户发来的)，超过速率丢弃
    tc filter add dev $INTERFACE parent ffff: protocol ip u32 match ip dport $PORT 0xffff \
    police rate ${RATE_KBIT}kbit burst $BURST drop flowid :1

    echo -e "${GREEN}[Success] 限速已应用！${PLAIN}"
    echo -e "端口: $PORT | 上行限制: ${RATE}Mbps | 下行限制: ${RATE}Mbps"
    
    # 询问是否测速
    read -p "是否立即进行测速验证？(y/n): " test_choice
    if [[ "$test_choice" == "y" ]]; then
        run_speedtest
    fi
}

# --- 功能 3：解除限速 ---
function remove_limit() {
    echo -e "${YELLOW}[Processing] 正在清除所有限速规则...${PLAIN}"
    clear_rules_silent
    echo -e "${GREEN}[Success] 限制已解除，网卡 $INTERFACE 恢复全速。${PLAIN}"
}

function clear_rules_silent() {
    # 静默清除规则，不报错
    tc qdisc del dev $INTERFACE root >/dev/null 2>&1
    tc qdisc del dev $INTERFACE ingress >/dev/null 2>&1
}

# --- 功能 4：可靠测速 (替换失效节点) ---
function run_speedtest() {
    echo -e "${YELLOW}[Testing] 开始测速验证 (使用 Cloudflare Global CDN)...${PLAIN}"
    
    # 使用 Cloudflare 的测速文件，非常稳定，不会像 DigitalOcean 某些节点那样 404
    TEST_URL="http://speed.cloudflare.com/__down?bytes=50000000" # 50MB 测试文件
    
    echo -e "正在下载测试 (50MB)..."
    # 使用 wget 的进度条显示速度，输出到 /dev/null
    wget -O /dev/null "$TEST_URL" --report-speed=bits
    
    echo -e "\n${GREEN}[Done] 测速完成。${PLAIN}"
    echo -e "注意：如果速度接近你设置的阈值，说明限速生效。"
}

# ================= 主菜单 =================
function show_menu() {
    clear
    echo -e "=================================="
    echo -e "   VPS 端口限速管理脚本 V2.0"
    echo -e "   当前网卡: ${GREEN}${INTERFACE}${PLAIN}"
    echo -e "=================================="
    echo -e "1. 查看活跃端口连接 (优化版)"
    echo -e "2. 设置端口限速 (双向限制)"
    echo -e "3. 解除所有限速"
    echo -e "4. 运行测速 (Cloudflare源)"
    echo -e "0. 退出脚本"
    echo -e "=================================="
    read -p "请输入选项 [0-4]: " choice

    case $choice in
        1)
            check_port_status
            read -p "按回车键返回菜单..."
            show_menu
            ;;
        2)
            set_limit
            read -p "按回车键返回菜单..."
            show_menu
            ;;
        3)
            remove_limit
            read -p "按回车键返回菜单..."
            show_menu
            ;;
        4)
            run_speedtest
            read -p "按回车键返回菜单..."
            show_menu
            ;;
        0)
            echo "退出脚本。"
            exit 0
            ;;
        *)
            echo -e "${RED}无效选项，请重试${PLAIN}"
            sleep 1
            show_menu
            ;;
    esac
}

# 启动脚本
show_menu
