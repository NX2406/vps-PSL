#!/bin/bash

# ==================================================
# VPS 流量控制台 V3.0 (Pro版)
# 功能：精准端口扫描 | 单/双向限速 | 指定解除 | 官方Speedtest
# ==================================================

# 颜色定义
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[36m'
PLAIN='\033[0m'

# 检查 root 权限
[[ $EUID -ne 0 ]] && echo -e "${RED}错误：${PLAIN} 必须使用 root 用户运行此脚本！\n" && exit 1

# 1. 自动获取物理网卡名称
INTERFACE=$(ip route get 8.8.8.8 | awk '{print $5; exit}')

# 初始化 TC 根队列 (如果不存在)
function init_tc() {
    # 检查是否已经初始化了 root htb
    if ! tc qdisc show dev $INTERFACE | grep -q "htb"; then
        tc qdisc add dev $INTERFACE root handle 1: htb default 10
        tc class add dev $INTERFACE parent 1: classid 1:1 htb rate 10000mbit # 总带宽池
        tc class add dev $INTERFACE parent 1:1 classid 1:10 htb rate 10000mbit # 默认不限速通道
    fi
    # 检查是否初始化了 ingress
    if ! tc qdisc show dev $INTERFACE | grep -q "ingress"; then
        tc qdisc add dev $INTERFACE handle ffff: ingress
    fi
}

# ================= 功能模块 =================

# --- 1. 活跃端口扫描 (修复版) ---
function check_port_status() {
    echo -e "${YELLOW}[Scanning] 正在深度扫描系统活跃端口...${PLAIN}"
    echo -e "----------------------------------------------------------------"
    printf "%-10s %-10s %-15s %-15s\n" "协议" "端口" "活跃连接数" "服务/进程"
    echo -e "----------------------------------------------------------------"

    # 获取所有监听端口 (TCP & UDP)
    # ss 输出格式处理: Netid State Recv-Q Send-Q Local Address:Port Peer Address:Port Process
    ss -tulpn | grep LISTEN | awk '{print $1, $5, $7}' | while read -r proto address process; do
        # 提取端口号 (移除IP前缀)
        port=$(echo "$address" | awk -F':' '{print $NF}')
        
        # 统计该端口的活跃连接 (ESTABLISHED)
        # 注意：UDP 没有严格的 ESTABLISHED 状态，但可以统计相关会话
        if [[ "$proto" == "tcp" ]]; then
            conn_count=$(ss -tn | awk '{print $4}' | grep ":$port$" | wc -l)
            proto_tag="${GREEN}TCP${PLAIN}"
        else
            conn_count=$(ss -un | awk '{print $4}' | grep ":$port$" | wc -l)
            proto_tag="${BLUE}UDP${PLAIN}"
        fi
        
        # 提取进程名
        proc_name=$(echo "$process" | awk -F'"' '{print $2}')
        [[ -z "$proc_name" ]] && proc_name="未知"

        printf "%-19s %-10s %-15s %-15s\n" "${proto_tag}" "${port}" "${conn_count}" "${proc_name}"
    done
    echo -e "----------------------------------------------------------------"
}

# --- 2. 核心限速逻辑 (支持单/双向) ---
function apply_limit() {
    local direction=$1 # in, out, bi
    
    echo -e "\n${BLUE}--- 配置限速规则 ($direction) ---${PLAIN}"
    read -p "请输入端口号: " PORT
    read -p "请输入速率 (Mbps): " RATE_MBPS
    
    # 转换单位
    RATE_KBIT=$(($RATE_MBPS * 1000))
    BURST="100k"

    init_tc

    # 定义逻辑：利用 priority 作为唯一ID，方便后续删除
    # 虽然 prio 范围有限，但对于端口级管理通常足够 (1-65535)
    
    # --- 下行限制 (Outbound / Egress) ---
    if [[ "$direction" == "out" || "$direction" == "bi" ]]; then
        echo -e "${YELLOW}[Config] 配置下行(发送)限制...${PLAIN}"
        # 1. 清除该端口旧规则 (如果有)
        tc filter del dev $INTERFACE parent 1:0 prio $PORT >/dev/null 2>&1
        tc class del dev $INTERFACE parent 1:1 classid 1:$PORT >/dev/null 2>&1

        # 2. 创建专属类 (ClassID 使用端口号，例如 1:8080)
        tc class add dev $INTERFACE parent 1:1 classid 1:$PORT htb rate ${RATE_KBIT}kbit ceil ${RATE_KBIT}kbit burst $BURST
        
        # 3. 创建过滤器 (Priority 使用端口号)
        tc filter add dev $INTERFACE protocol ip parent 1:0 prio $PORT u32 match ip sport $PORT 0xffff flowid 1:$PORT
    fi

    # --- 上行限制 (Inbound / Ingress) ---
    if [[ "$direction" == "in" || "$direction" == "bi" ]]; then
        echo -e "${YELLOW}[Config] 配置上行(接收)限制...${PLAIN}"
        # 1. 清除旧规则
        tc filter del dev $INTERFACE parent ffff: prio $PORT >/dev/null 2>&1
        
        # 2. 创建 Ingress 过滤器 (Priority 使用端口号)
        tc filter add dev $INTERFACE parent ffff: protocol ip prio $PORT u32 match ip dport $PORT 0xffff \
        police rate ${RATE_KBIT}kbit burst $BURST drop flowid :1
    fi

    echo -e "${GREEN}[Success] 端口 $PORT 限速已生效！模式: $direction | 速率: ${RATE_MBPS} Mbps${PLAIN}"
}

# --- 3. 解除指定端口限制 ---
function remove_port_limit() {
    echo -e "\n${BLUE}--- 解除端口限制 ---${PLAIN}"
    check_port_status # 先展示端口让用户看
    echo -e ""
    read -p "请输入要解除限制的端口号: " PORT
    
    echo -e "${YELLOW}[Clean] 正在清除端口 $PORT 的规则...${PLAIN}"
    
    # 尝试删除下行规则
    tc filter del dev $INTERFACE parent 1:0 prio $PORT >/dev/null 2>&1
    tc class del dev $INTERFACE parent 1:1 classid 1:$PORT >/dev/null 2>&1
    
    # 尝试删除上行规则
    tc filter del dev $INTERFACE parent ffff: prio $PORT >/dev/null 2>&1
    
    echo -e "${GREEN}[Done] 端口 $PORT 已恢复全速 (或规则不存在)。${PLAIN}"
}

# --- 4. 彻底重置 ---
function reset_all() {
    echo -e "${RED}[Warning] 这将清除网卡 $INTERFACE 上所有的流量控制规则！${PLAIN}"
    read -p "确认执行? (y/n): " confirm
    if [[ "$confirm" == "y" ]]; then
        tc qdisc del dev $INTERFACE root >/dev/null 2>&1
        tc qdisc del dev $INTERFACE ingress >/dev/null 2>&1
        echo -e "${GREEN}[Success] 已重置所有限制。${PLAIN}"
    fi
}

# --- 5. 专业测速 (集成 Speedtest CLI) ---
function run_pro_speedtest() {
    echo -e "${YELLOW}[Testing] 正在准备测速环境...${PLAIN}"
    
    # 检查是否已安装官方 CLI
    if [ ! -f "./speedtest" ]; then
        echo "正在下载 Speedtest 官方客户端..."
        # 自动判断架构下载
        ARCH=$(uname -m)
        if [[ "$ARCH" == "x86_64" ]]; then
            URL="https://install.speedtest.net/app/cli/ookla-speedtest-1.2.0-linux-x86_64.tgz"
        elif [[ "$ARCH" == "aarch64" ]]; then
            URL="https://install.speedtest.net/app/cli/ookla-speedtest-1.2.0-linux-aarch64.tgz"
        else
            echo -e "${RED}不支持的架构，切换回简易模式。${PLAIN}"
            run_simple_test
            return
        fi
        
        curl -sL $URL | tar xz speedtest
        chmod +x speedtest
    fi

    echo -e "${GREEN}[Running] 开始测速 (Ookla)... 请稍候${PLAIN}"
    echo -e "---------------------------------------------------"
    
    # 运行测速并接受许可，抑制多余输出
    ./speedtest --accept-license --accept-gdpr > speedtest_result.txt
    
    # 解析并美化输出
    ISP=$(grep "ISP:" speedtest_result.txt | cut -d ':' -f 2 | xargs)
    SERVER=$(grep "Server:" speedtest_result.txt | cut -d ':' -f 2 | xargs)
    PING=$(grep "Idle Latency:" speedtest_result.txt | cut -d ':' -f 2 | xargs)
    DL=$(grep "Download:" speedtest_result.txt | cut -d ':' -f 2 | xargs)
    UL=$(grep "Upload:" speedtest_result.txt | cut -d ':' -f 2 | xargs)
    PACKET_LOSS=$(grep "Packet Loss:" speedtest_result.txt | cut -d ':' -f 2 | xargs)
    
    echo -e "运营商   : ${BLUE}$ISP${PLAIN}"
    echo -e "测速节点 : ${BLUE}$SERVER${PLAIN}"
    echo -e "延迟     : ${YELLOW}$PING${PLAIN}"
    echo -e "丢包率   : ${YELLOW}${PACKET_LOSS:-0%}${PLAIN}"
    echo -e "---------------------------------------------------"
    echo -e "下行速度 (Download) : ${GREEN}$DL${PLAIN}"
    echo -e "上行速度 (Upload)   : ${GREEN}$UL${PLAIN}"
    echo -e "---------------------------------------------------"
    
    rm speedtest_result.txt
}

function run_simple_test() {
    # 备用方案
    wget -O /dev/null http://speed.cloudflare.com/__down?bytes=50000000 --report-speed=bits
}

# ================= 主菜单 =================
function show_menu() {
    clear
    echo -e "=================================================="
    echo -e "           VPS 流量整形与限速专家 V3.0"
    echo -e "           当前网卡: ${GREEN}${INTERFACE}${PLAIN}"
    echo -e "=================================================="
    echo -e "1. 查看活跃端口 (协议/连接数/进程)"
    echo -e "--------------------------------------------------"
    echo -e "2. 设置限速 - ${BLUE}仅下行${PLAIN} (限制发送/Download)"
    echo -e "3. 设置限速 - ${BLUE}仅上行${PLAIN} (限制接收/Upload)"
    echo -e "4. 设置限速 - ${YELLOW}双向限制${PLAIN}"
    echo -e "--------------------------------------------------"
    echo -e "5. 解除 ${RED}指定端口${PLAIN} 的限速"
    echo -e "6. 解除 ${RED}全部${PLAIN} 限速规则 (重置网卡)"
    echo -e "--------------------------------------------------"
    echo -e "7. 运行专业测速 (Speedtest.net)"
    echo -e "0. 退出"
    echo -e "=================================================="
    read -p "请输入选项 [0-7]: " choice

    case $choice in
        1) check_port_status; read -p "按回车返回..."; show_menu ;;
        2) apply_limit "out"; read -p "按回车返回..."; show_menu ;;
        3) apply_limit "in"; read -p "按回车返回..."; show_menu ;;
        4) apply_limit "bi"; read -p "按回车返回..."; show_menu ;;
        5) remove_port_limit; read -p "按回车返回..."; show_menu ;;
        6) reset_all; read -p "按回车返回..."; show_menu ;;
        7) run_pro_speedtest; read -p "按回车返回..."; show_menu ;;
        0) exit 0 ;;
        *) echo "无效输入"; sleep 1; show_menu ;;
    esac
}

show_menu
