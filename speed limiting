#!/bin/bash

# ==================================================
# VPS 流量控制台 V9.0 (Performance Tuned)
# 核心修复：关闭网卡Offload防止卡死 | 优先级队列优化
# ==================================================

# 颜色定义
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[36m'
PLAIN='\033[0m'

# 检查 root
[[ $EUID -ne 0 ]] && echo -e "${RED}错误：请使用 root 用户运行！${PLAIN}" && exit 1

# 获取网卡
INTERFACE=$(ip route get 8.8.8.8 | awk '{print $5; exit}')

# QUANTUM 设置
USER_QUANTUM=15000
ROOT_QUANTUM=200000

# ================= 核心优化函数 (新增) =================

function optimize_network() {
    echo -e "${YELLOW}[System] 正在优化网络栈以防止流量整形卡顿...${PLAIN}"
    
    # 1. 检查并安装 ethtool (用于关闭 offloading)
    if ! command -v ethtool &> /dev/null; then
        echo "正在安装 ethtool..."
        if [[ -f /etc/debian_version ]]; then
            apt-get update -y && apt-get install ethtool -y
        elif [[ -f /etc/redhat-release ]]; then
            yum install ethtool -y
        fi
    fi

    # 2. [关键] 关闭网卡卸载特性
    # 这能解决开启限速后，未限速端口测速卡死/延迟飙升的问题
    if command -v ethtool &> /dev/null; then
        ethtool -K $INTERFACE tso off gso off gro off >/dev/null 2>&1
        echo -e "${GREEN}[OK] 已关闭 GSO/TSO/GRO 硬件卸载 (提升 TC 稳定性)${PLAIN}"
    else
        echo -e "${RED}[Warn] ethtool 安装失败，跳过硬件优化。${PLAIN}"
    fi
}

# ================= TC 初始化 =================

function init_tc_tree() {
    optimize_network # 每次初始化前先优化

    if ! tc qdisc show dev $INTERFACE | grep -q "htb"; then
        tc qdisc add dev $INTERFACE root handle 1: htb default 10 r2q 10
    fi
    
    # 建立总池 1:1
    if ! tc class show dev $INTERFACE | grep -q "1:1 "; then
        tc class add dev $INTERFACE parent 1: classid 1:1 htb rate 10000mbit quantum $ROOT_QUANTUM
    fi
    
    # [关键优化] 建立默认通道 1:10 (未限速通道)
    # 赋予 prio 0 (最高优先级)，确保正常流量不排队
    if ! tc class show dev $INTERFACE | grep -q "1:10 "; then
        tc class add dev $INTERFACE parent 1:1 classid 1:10 htb rate 10000mbit prio 0 quantum $ROOT_QUANTUM
    fi
    
    if ! tc qdisc show dev $INTERFACE | grep -q "ingress"; then
        tc qdisc add dev $INTERFACE handle ffff: ingress
    fi
}

# ================= 辅助函数 =================

function select_active_port() {
    echo -e "${YELLOW}[List] 活跃端口扫描...${PLAIN}"
    echo -e "------------------------------------------------"
    printf "%-5s %-10s %-12s %-20s\n" "编号" "协议" "端口" "进程"
    echo -e "------------------------------------------------"

    declare -a port_list
    index=1

    while read -r line; do
        proto=$(echo $line | awk '{print $1}')
        address=$(echo $line | awk '{print $2}')
        process=$(echo $line | awk '{print $3}')
        port=$(echo "$address" | awk -F':' '{print $NF}')
        proc_name=$(echo "$process" | awk -F'"' '{print $2}')
        [[ -z "$proc_name" ]] && proc_name="-"

        port_list[$index]=$port
        printf "${GREEN}[%d]${PLAIN}   %-10s %-12s %-20s\n" "$index" "$proto" "$port" "$proc_name"
        ((index++))
    done < <(ss -tulpn | grep LISTEN | awk '{print $1, $5, $7}')

    echo -e "------------------------------------------------"
    echo -e "${GREEN}[m]${PLAIN}   手动输入"
    echo -e "------------------------------------------------"
    
    read -p "请选择编号: " select_idx

    if [[ "$select_idx" == "m" ]]; then
        read -p "端口号: " input_port
        if ! [[ "$input_port" =~ ^[0-9]+$ ]]; then
            echo -e "${RED}错误：必须是数字${PLAIN}"; SELECTED_PORT=""; return
        fi
        SELECTED_PORT=$input_port
    elif [[ -n "${port_list[$select_idx]}" ]]; then
        SELECTED_PORT="${port_list[$select_idx]}"
        echo -e "${BLUE}选中端口: $SELECTED_PORT${PLAIN}"
    else
        echo -e "${RED}无效选择${PLAIN}"; SELECTED_PORT=""
    fi
}

function check_port_status() {
    clear
    echo -e "${YELLOW}[Scanning] 端口状态监控...${PLAIN}"
    echo -e "----------------------------------------------------------------------"
    printf "%-10s %-12s %-15s %-15s %-20s\n" "协议" "端口" "状态" "活跃连接数" "进程名"
    echo -e "----------------------------------------------------------------------"

    ss -tulpn | grep LISTEN | awk '{print $1, $5, $7}' | while read -r proto address process; do
        port=$(echo "$address" | awk -F':' '{print $NF}')
        if [[ "$proto" == "tcp" ]]; then
            ptag="TCP"; pcolor="${GREEN}"
            conn=$(ss -tn state established | awk '{print $4}' | grep -w ":$port" | wc -l)
        else
            ptag="UDP"; pcolor="${BLUE}"
            conn=$(ss -un | awk '{print $4}' | grep -w ":$port" | wc -l)
        fi
        proc=$(echo "$process" | awk -F'"' '{print $2}')
        [[ -z "$proc" ]] && proc="-"
        if [[ "$conn" -gt 0 ]]; then
            conn_str="${conn} (Active)"; conn_color="${RED}"
        else
            conn_str="0"; conn_color="${PLAIN}"
        fi
        printf "${pcolor}%-10s${PLAIN} %-12s %-15s ${conn_color}%-15s${PLAIN} %-20s\n" "$ptag" "$port" "Listening" "$conn_str" "$proc"
    done
    echo -e "----------------------------------------------------------------------"
}

# --- 功能 2：端口限速 ---
function apply_port_limit() {
    echo -e "\n${BLUE}--- 配置端口限速 ---${PLAIN}"
    select_active_port
    [[ -z "$SELECTED_PORT" ]] && return
    PORT=$SELECTED_PORT

    echo -e "\n请选择限制方向："
    echo -e "1. ${GREEN}下行${PLAIN} (下载)"
    echo -e "2. ${GREEN}上行${PLAIN} (上传)"
    echo -e "3. ${YELLOW}双向${PLAIN}"
    read -p "选项 [1-3]: " dir_choice
    case $dir_choice in
        1) direction="out" ;; 2) direction="in" ;; 3) direction="bi" ;; *) direction="bi" ;;
    esac

    read -p "速率 (Mbps): " RATE_MBPS
    RATE_KBIT=$(($RATE_MBPS * 1000))
    BURST="100k"
    HEX_ID=$(printf '%x' $PORT)

    init_tc_tree

    echo -e "${YELLOW}[Config] 正在应用...${PLAIN}"

    if [[ "$direction" == "out" || "$direction" == "bi" ]]; then
        tc filter del dev $INTERFACE parent 1:0 prio $PORT >/dev/null 2>&1
        tc class del dev $INTERFACE parent 1:1 classid 1:$HEX_ID >/dev/null 2>&1
        
        # [关键优化] 被限速的端口给予 prio 1 (低优先级)
        # 这样当网络拥堵时，未限速的 prio 0 流量会优先通过，不会卡顿
        tc class add dev $INTERFACE parent 1:1 classid 1:$HEX_ID htb rate ${RATE_KBIT}kbit ceil ${RATE_KBIT}kbit burst $BURST prio 1 quantum $USER_QUANTUM
        
        tc filter add dev $INTERFACE protocol ip parent 1:0 prio $PORT u32 match ip sport $PORT 0xffff flowid 1:$HEX_ID
    fi

    if [[ "$direction" == "in" || "$direction" == "bi" ]]; then
        tc filter del dev $INTERFACE parent ffff: prio $PORT >/dev/null 2>&1
        tc filter add dev $INTERFACE parent ffff: protocol ip prio $PORT u32 match ip dport $PORT 0xffff \
        police rate ${RATE_KBIT}kbit burst $BURST drop flowid :1
    fi

    echo -e "${GREEN}[Success] 端口 $PORT 限速生效 (低优先级)。${PLAIN}"
}

# --- 功能 3：全局限速 ---
function apply_global_limit() {
    echo -e "\n${BLUE}--- 全局限速 ---${PLAIN}"
    read -p "总速率 (Mbps): " RATE_MBPS
    RATE_KBIT=$(($RATE_MBPS * 1000))
    BURST="100k"
    
    optimize_network
    
    tc qdisc del dev $INTERFACE root >/dev/null 2>&1
    tc qdisc del dev $INTERFACE ingress >/dev/null 2>&1

    tc qdisc add dev $INTERFACE root handle 1: htb default 10 r2q 10
    tc class add dev $INTERFACE parent 1: classid 1:1 htb rate ${RATE_KBIT}kbit ceil ${RATE_KBIT}kbit burst $BURST quantum $USER_QUANTUM
    tc class add dev $INTERFACE parent 1:1 classid 1:10 htb rate ${RATE_KBIT}kbit ceil ${RATE_KBIT}kbit burst $BURST prio 0 quantum $USER_QUANTUM

    tc qdisc add dev $INTERFACE handle ffff: ingress
    tc filter add dev $INTERFACE parent ffff: protocol ip prio 50 u32 match ip src 0.0.0.0/0 \
    police rate ${RATE_KBIT}kbit burst $BURST drop flowid :1
    echo -e "${GREEN}[Success] 全局限速生效。${PLAIN}"
}

# --- 功能 4：解除限制 ---
function remove_limit() {
    echo -e "\n1. 解除指定端口"
    echo -e "2. 重置所有 (恢复默认)"
    read -p "选择: " sel
    
    if [[ "$sel" == "1" ]]; then
        select_active_port
        [[ -z "$SELECTED_PORT" ]] && return
        PORT=$SELECTED_PORT
        HEX_ID=$(printf '%x' $PORT)
        
        echo -e "\n1. 仅解除 ${GREEN}下行${PLAIN}"
        echo -e "2. 仅解除 ${GREEN}上行${PLAIN}"
        echo -e "3. 解除 ${RED}双向${PLAIN}"
        read -p "选项: " rm_choice
        case $rm_choice in
            1) 
                tc filter del dev $INTERFACE parent 1:0 prio $PORT >/dev/null 2>&1
                tc class del dev $INTERFACE parent 1:1 classid 1:$HEX_ID >/dev/null 2>&1
                echo -e "${GREEN}端口 $PORT [下行] 已移除。${PLAIN}" ;;
            2) 
                tc filter del dev $INTERFACE parent ffff: prio $PORT >/dev/null 2>&1
                echo -e "${GREEN}端口 $PORT [上行] 已移除。${PLAIN}" ;;
            *) 
                tc filter del dev $INTERFACE parent 1:0 prio $PORT >/dev/null 2>&1
                tc class del dev $INTERFACE parent 1:1 classid 1:$HEX_ID >/dev/null 2>&1
                tc filter del dev $INTERFACE parent ffff: prio $PORT >/dev/null 2>&1
                echo -e "${GREEN}端口 $PORT [双向] 已移除。${PLAIN}" ;;
        esac
    elif [[ "$sel" == "2" ]]; then
        tc qdisc del dev $INTERFACE root >/dev/null 2>&1
        tc qdisc del dev $INTERFACE ingress >/dev/null 2>&1
        # 重置时最好也恢复 offloading，但通常保持关闭也没坏处，这里简单处理
        echo -e "${GREEN}限制已重置。${PLAIN}"
    fi
}

function run_pro_speedtest() {
    echo -e "${YELLOW}[Testing] Speedtest...${PLAIN}"
    if [ ! -f "./speedtest" ]; then
        ARCH=$(uname -m)
        [[ "$ARCH" == "x86_64" ]] && URL="https://install.speedtest.net/app/cli/ookla-speedtest-1.2.0-linux-x86_64.tgz"
        [[ "$ARCH" == "aarch64" ]] && URL="https://install.speedtest.net/app/cli/ookla-speedtest-1.2.0-linux-aarch64.tgz"
        curl -sL $URL | tar xz speedtest && chmod +x speedtest
    fi
    ./speedtest --accept-license --accept-gdpr
}

# ================= 菜单 =================
function show_menu() {
    clear
    echo -e "=================================================="
    echo -e "       VPS 流量控制台 V9.0 (Anti-Lag)"
    echo -e "       网卡: ${GREEN}${INTERFACE}${PLAIN}"
    echo -e "=================================================="
    echo -e "1. 查看活跃端口"
    echo -e "--------------------------------------------------"
    echo -e "2. 设置 ${YELLOW}端口限速${PLAIN} (自动优化防卡顿)"
    echo -e "3. 设置 ${RED}全局限速${PLAIN}"
    echo -e "--------------------------------------------------"
    echo -e "4. 解除限制 (支持方向选择)"
    echo -e "5. 运行测速"
    echo -e "0. 退出"
    echo -e "=================================================="
    read -p "选择: " choice

    case $choice in
        1) check_port_status; read -p "回车返回..." ;;
        2) apply_port_limit; read -p "回车返回..." ;;
        3) apply_global_limit; read -p "回车返回..." ;;
        4) remove_limit; read -p "回车返回..." ;;
        5) run_pro_speedtest; read -p "回车返回..." ;;
        0) exit 0 ;;
        *) show_menu ;;
    esac
    show_menu
}

show_menu
