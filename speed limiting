#!/bin/bash
# ==========================================
# 网络协议栈深度复位工具 (终极版)
# ==========================================

# 1. 锁定网卡
IFACE=$(ip route get 8.8.8.8 | awk '{print $5; exit}')
echo ">>> 当前网卡: $IFACE"

# 2. 诊断：看看是不是还有 TC 规则在潜伏
echo -e "\n[1/5] 正在检查残留的限速规则..."
TC_CHECK=$(tc qdisc show dev $IFACE)
if [[ $TC_CHECK == *"htb"* || $TC_CHECK == *"sfq"* || $TC_CHECK == *"ingress"* ]]; then
    echo "警告：发现顽固规则！正在暴力清除..."
    tc qdisc del dev $IFACE root >/dev/null 2>&1
    tc qdisc del dev $IFACE ingress >/dev/null 2>&1
    echo ">>> 清除完毕。"
else
    echo ">>> 未发现 TC 限速规则 (说明限速本身已解除)。"
fi

# 3. 诊断：检查防火墙是否被脚本修改
echo -e "\n[2/5] 正在重置防火墙规则 (防止丢包策略残留)..."
# 备份一下防止误删关键规则，但为了恢复通常建议全清
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
iptables -t nat -F
iptables -t mangle -F
iptables -F
iptables -X
echo ">>> 防火墙已重置为全放行状态。"

# 4. 诊断：检查网卡 MTU 和 队列长度
echo -e "\n[3/5] 正在恢复网卡物理参数..."
ip link set dev $IFACE mtu 1500
if command -v ethtool &>/dev/null; then
    ethtool -K $IFACE tso on gso on gro on >/dev/null 2>&1
fi
echo ">>> 网卡 MTU/Offload 已恢复默认。"

# 5. 诊断：清理可能存在的残留文件
echo -e "\n[4/5] 检查开机自启残留..."
# 检查 rc.local 中是否还有 limit.sh
if [ -f /etc/rc.local ]; then
    if grep -q "limit.sh" /etc/rc.local; then
        echo "警告：发现 rc.local 中有脚本残留，正在剔除..."
        sed -i '/limit.sh/d' /etc/rc.local
    fi
fi
echo ">>> 自启检查完毕。"

# 6. 验证：直接拉取文件测试 (避开 Speedtest 节点抽风问题)
echo -e "\n[5/5] 最终验证：直接从 Cloudflare 拉取文件测速..."
echo "正在测试下行速度 (目标: 恢复正常带宽)..."
# 使用 curl 打印速度，超时时间 10秒
curl -o /dev/null http://speed.cloudflare.com/__down?bytes=50000000 -w "\n下载速度: %{speed_download} byte/s\n" --connect-timeout 5 --max-time 15

echo -e "\n=========================================="
echo " 如果上面的下载速度显示正常 (如几MB/s或几十MB/s)，"
echo " 说明你的 VPS 网络已完全恢复！"
echo " 如果依然只有几KB，说明大概率是被 VPS 商家限速了。"
echo "=========================================="
